<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>陪伴者課表系統</title>

    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-firestore.js"></script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-p34f1UUtsS3wqzfto5wAAmdvj+osOnFyQFpp4Ua3gs/ZVWx6oOypYoCJhGGScy+8"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" type="text/css" href="css/form.css" />
    <style>
      @media print {
        .hidden-on-print {
          display: none !important;
        }
      }
    </style>
  </head>

  <body>
    <div class="website d-md-none">響應式斷點測試;</div>
    <div class="hidden-on-print">
      <h1 class="visually-hidden">課表首頁</h1>
      <div class="container-fluid p-0">
        <header
          class="d-flex flex-wrap justify-content-center py-3 mb-8 bg-dark border-bottom"
        >
          <a
            href="/"
            class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none"
          >
            <img
              class="bi me-2"
              width="40"
              height="32"
              src="logo.png"
              alt="Logo"
            />
            <span class="fs-4 text-white">課表首頁</span>
          </a>

          <button
            type="button"
            class="btn btn-light me-2"
            onclick="window.location.href = 'about.html'"
          >
            關於
          </button>
          <button
            type="button"
            class="btn btn-light me-2"
            onclick="window.location.href = 'login.html'"
          >
            登入
          </button>
        </header>
      </div>

      <div class="date">
        <div class="container-fluid p-0">
          <div class="row align-items-start">
            <div class="col-md-10 text-end">
              <h4>選擇課表日期:</h4>
            </div>
            <div class="col">
              <button
                class="btn btn-secondary dropdown-toggle"
                href="#"
                role="button"
                id="dropdownMenuLink"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                選擇日期
              </button>
              <ul
                class="dropdown-menu"
                id="dateDropdown"
                aria-labelledby="dropdownMenuButton1"
              ></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Display Firestore data -->
    <div id="firestore-data"></div>

    <script type="module">
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCwzvhGZlpxlVV32iMO6m9eL0fAsRiRisU",
        authDomain: "tlrca-75fc9.firebaseapp.com",
        projectId: "tlrca-75fc9",
        storageBucket: "tlrca-75fc9.appspot.com",
        messagingSenderId: "841216398641",
        appId: "1:841216398641:web:b2a4253470657a117f0c10",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);

      // Reference to Firestore collection
      const firestore = firebase.firestore();
      const collection = firestore.collection("classroom");

      const today = new Date();
      const todayYear = today.getFullYear();
      const todayMonth = today.getMonth() + 1; // 月份从 0 开始，所以要加 1
      const todayDate = today.getDate();

      // Real-time listener for Firestore data changes
      collection.onSnapshot((snapshot) => {
        onCourseData(
          snapshot.docs.map((doc) => {
            return doc.data();
          })
        );
      });

      // Code here
      function onCourseData(docs) {
        const firestoreDataDiv = document.getElementById("firestore-data");
        // default data
        firestoreDataDiv.innerHTML = JSON.stringify(docs, null, 4);

        // create table
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const tbody = document.createElement("tbody");

        // define type tr表格行/th單個 粗體/td可與tbody/footu一起
        const titles = [
          "時間/教室",
          "教室1",
          "教室2",
          "教室3",
          "交誼廳",
          "三能/線上",
        ];

        const trHead = document.createElement("tr");
        titles.forEach((title) => {
          const th = document.createElement("th");
          th.textContent = title;
          trHead.appendChild(th);
        });
        thead.appendChild(trHead);

        const timeRows = {}; // 用來存放各個時間對應的行

        // Sort the docs based on the first section's start time
        docs.sort((a, b) => {
          const timeA = a["Sections"][0].split("-")[0].trim();
          const timeB = b["Sections"][0].split("-")[0].trim();
          return (
            new Date(`2024-01-01 ${timeA}`) - new Date(`2024-01-01 ${timeB}`)
          );
        });

        docs.forEach((doc) => {
          const sections = doc["Sections"] || [];
          const time = sections.length > 0 ? sections[0] : "N/A";

          // 检查日期是否为今天
          const docDate = new Date(doc["Date"].seconds * 1000);
          const docYear = docDate.getFullYear();
          const docMonth = docDate.getMonth() + 1;
          const docDay = docDate.getDate();
          const isToday =
            todayYear === docYear &&
            todayMonth === docMonth &&
            todayDate === docDay;

          // Check if a row with this time already exists and the date is today
          let tr = timeRows[time];
          if (!tr && isToday) {
            tr = document.createElement("tr");
            timeRows[time] = tr;

            const timeTd = document.createElement("td");
            timeTd.textContent = time;
            tr.appendChild(timeTd);

            titles.slice(1).forEach((title) => {
              const td = document.createElement("td");
              td.textContent = "."; // Set default value to '.'
              tr.appendChild(td);
            });
          }

          // Populate the cells for Classroom, Teacher, and Course if the date is today
          if (isToday) {
            titles.slice(1).forEach((title, index) => {
              const td = tr.children[index + 1]; // Skip the first td for time
              if (title === doc["Classroom"]) {
                td.textContent = `${doc["Teacher"] || "N/A"} / ${
                  doc["Course"] || "N/A"
                }`;
              }
            });
          }

          if (isToday) {
            tbody.appendChild(tr);
          }
        });
        table.innerHTML = "";
        table.appendChild(thead);
        table.appendChild(tbody);

        // replace the existing table with the new one
        const existingTable = document.getElementById("timetable");
        if (existingTable) {
          existingTable.parentNode.replaceChild(table, existingTable);
        } else {
          document.body.appendChild(table);
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        // 获取当前日期
        function getCurrentDate() {
          var today = new Date();
          var year = today.getFullYear();
          var month = String(today.getMonth() + 1).padStart(2, "0");
          var day = String(today.getDate()).padStart(2, "0");
          return year + "-" + month + "-" + day;
        }
        // 更新下拉菜单内容
        function updateDropdown() {
          var dropdownMenu = document.querySelector(".dropdown-menu");
          dropdownMenu.innerHTML = ""; // 清空原有内容
          // 添加新的日期选项
          for (var i = 0; i < 7; i++) {
            // 这里假设添加最近7天的日期
            var date = new Date();
            date.setDate(date.getDate() + i);
            var formattedDate =
              date.getFullYear() +
              "-" +
              String(date.getMonth() + 1).padStart(2, "0") +
              "-" +
              String(date.getDate()).padStart(2, "0");
            var dropdownItem = document.createElement("li");
            dropdownItem.classList.add("dropdown-item");
            dropdownItem.innerHTML =
              '<a class="dropdown-item" href="#">' + formattedDate + "</a>";
            dropdownMenu.appendChild(dropdownItem);
          }
        }

        // 初始化下拉菜单
        updateDropdown();

        // 添加点击事件处理程序，您可以在选择日期时执行相应的操作
        document
          .querySelector(".dropdown-menu")
          .addEventListener("click", function (event) {
            var selectedDate = event.target.textContent;
            //document.querySelector('#dateDropdown').textContent = selectedDate;

            //選擇後操作
            console.log(docdate);
          });

        setInterval(function () {
          updateDropdown();
        }, 600000);
      });
    </script>
  </body>
</html>
