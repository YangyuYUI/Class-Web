<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>陪伴者課表系統</title>

    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-firestore.js"></script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- /<script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-p34f1UUtsS3wqzfto5wAAmdvj+osOnFyQFpp4Ua3gs/ZVWx6oOypYoCJhGGScy+8"
      crossorigin="anonymous"
    ></script> -->
    <link rel="stylesheet" type="text/css" href="css/form.css" />
    <link rel="stylesheet" type="text/css" href="css/footer.css" />
    <style>
      @media print {
        .hidden-on-print {
          display: none !important;
        }
      }
    </style>
  </head>

  <body>
    <div class="hidden-on-print">
      <!-- <div class="website d-md-none">響應式斷點測試;</div> -->
      <h1 class="visually-hidden">課表編輯</h1>
      <div class="container-fluid p-0">
        <header
          class="d-flex flex-wrap justify-content-center py-3 mb-8 bg-dark border-bottom"
        >
          <a
            href="/"
            class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none"
          >
            <img
              class="bi me-2"
              width="40"
              height="32"
              src="logo.png"
              alt="Logo"
            />
            <span class="fs-4 text-white">課表編輯</span>
          </a>

          <button
            type="button"
            class="btn btn-light me-2"
            onclick="window.location.href = 'about.html'"
          >
            關於
          </button>
          <button
            type="button"
            class="btn btn-light me-2"
            onclick="window.location.href = 'login.html'"
            id="signOutButton"
          >
            登出
          </button>
        </header>
      </div>

      <div class="date">
        <div class="container-fluid p-0">
          <div class="row align-items-start">
            <div class="col-md-10 text-end">
              <h4>選擇課表日期:</h4>
            </div>
            <div class="col">
              <button
                class="btn btn-secondary dropdown-toggle"
                href="#"
                role="button"
                id="dropdownMenuLink"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                選擇日期
              </button>
              <ul
                class="dropdown-menu"
                id="dateDropdown"
                aria-labelledby="dropdownMenuButton1"
              >
                <li>選項 1</li>
              </ul>
            </div>
          </div>
          <!-- <button id="addCourseButton" class="btn btn-secondary">
            addCouse
          </button> -->

          <button
            type="button"
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#exampleModal"
          >
            新增課程
          </button>
          <!-- data-bs-whatever="教室" -->
          <div
            class="modal fade"
            id="exampleModal"
            tabindex="-1"
            aria-labelledby="exampleModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">
                    請填入課程資料
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <form>
                    <input type="date" id="bookdate" />
                    課程時間

                    <div class="col">
                      <button
                        type="button"
                        class="btn btn-secondary dropdown-toggle"
                        href="#"
                        role="button"
                        id="timedropdown"
                        data-bs-toggle="dropdown"
                        aria-expanded="false"
                      >
                        選擇時間
                      </button>
                      <ul
                        class="dropdown-menu"
                        id="timeDropdownStart"
                        aria-labelledby="dropdownMenuButton2"
                      >
                        <li>選項 1</li>
                      </ul>
                    </div>
                    ~
                    <div class="col">
                      <button
                        type="button"
                        class="btn btn-secondary dropdown-toggle"
                        href="#"
                        role="button"
                        id="timedropdownEnd"
                        data-bs-toggle="dropdown"
                        aria-expanded="false"
                      >
                        選擇時間
                      </button>
                      <ul
                        class="dropdown-menu"
                        id="timeDropdownEnd"
                        aria-labelledby="dropdownMenuButton2"
                      >
                        <li>選項 1</li>
                      </ul>
                    </div>

                    <div class="mb-3">
                      <label for="recipient-name" class="col-form-label"
                        >教室</label
                      >

                      <div class="dropdown">
                        <button
                          type="button"
                          class="btn btn-secondary dropdown-toggle"
                          href="#"
                          role="button"
                          id="classDropdownButton"
                          data-bs-toggle="dropdown"
                          aria-expanded="false"
                        >
                          選擇教室:
                        </button>

                        <ul
                          class="dropdown-menu"
                          aria-labelledby="classdropdownButton"
                          id="dropdownmenuclass"
                        >
                          <li><a class="dropdown-item" href="#">教室1</a></li>
                          <li><a class="dropdown-item" href="#">教室2</a></li>
                          <li><a class="dropdown-item" href="#">教室3</a></li>
                          <li><a class="dropdown-item" href="#">交誼廳</a></li>
                          <li>
                            <a class="dropdown-item" href="#">三能/線上</a>
                          </li>
                        </ul>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="recipient-name" class="col-form-label"
                        >課程</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="classinput2"
                      />
                    </div>
                    <div class="mb-3">
                      <label for="recipient-name" class="col-form-label"
                        >老師</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="classinput3"
                      />
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <div>
                    <font class="visually-hidden" id="addsuccess" color="#198754"> 課程提交成功！</font>
                  
                  </div>
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    關閉
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary"
                    id="addCourseButton"
                  >
                    提交資料
                    <div
                      class="visually-hidden ms-1 spinner-border spinner-border-sm"
                      role="status"
                      id="loading"
                    >
                      <span class="visually-hidden">Loading...</span>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Button trigger modal -->
          <button
            type="button"
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#deleteModal"
            id="delete"
          >
            DELETE
          </button>

          <!-- Modal -->
          <div
            class="modal fade"
            id="deleteModal"
            tabindex="-1"
            aria-labelledby="deleteModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="deleteModalLabel">刪除課程</h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <div id="course-list"></div>
                  <div id="login-form">
                    <label class="visually-hidden" for="docId">docId:</label>
                    <input class="visually-hidden" type="text" id="docId" required />
                    <button id="deleteButton" class="visually-hidden btn btn-secondary btn-sm">
                      delete
                    </button>
                  </div>
                  <!-- <button type="button" class="btn btn-primary" id="deleteCourse">刪除</button> -->
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    關閉
                  </button>
                  <!-- <button type="button" class="btn btn-primary">
                    待調整
                  </button> -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="courseTable"></div>

    <div class="hidden-on-print">
      <footer class="site-footer mt-5">
        <div class="container">
          <div class="row">
            <div class="col-sm-12 col-md-6">
              <h6>關於陪伴者</h6>
              <p class="text-justify">以下訊息為測試用皆可修改 暫時先空著</p>
            </div>

            <div class="col-xs-6 col-md-3">
              <h6>捐款資訊</h6>
              <ul class="footer-links">
                <li>戶名：社團法人陪伴者兒少生涯教育協會</li>
                <li>銀行：上海商銀 松南分行 (代碼：011)</li>
                <li>帳號：31102-0000-22460</li>
                <li>郵政劃撥帳號：5019-5144</li>
                <li>愛心碼：2631098</li>
              </ul>
            </div>

            <div class="col-xs-6 col-md-3">
              <h6>聯絡我們</h6>
              <ul class="footer-links">
                <li>服務時間：星期一至五 9:00~18:00</li>
                <li>社團法人陪伴者兒少生涯教育協會</li>
                <li>TEL：02-2325-9026</li>
                <li>FAX：02-2325-6372</li>
                <li>陪伴者實驗教育機構</li>
                <li>TEL：02-2708-2776</li>
                <li>
                  地址：<a
                    href="https://maps.app.goo.gl/gsEouxXhmVWZf6cr6"
                    title="map"
                    target="_blank"
                    rel="noopener"
                    >10692台北市大安區信義路四段341號7樓之1</a
                  >
                </li>
              </ul>
            </div>
          </div>
          <hr />
        </div>
        <div class="container p-1">
          <div class="row">
            <div class="col-md-8 col-sm-6 col-xs-12">
              <p class="copyright-text">
                Copyright &copy; 2024
                <a href="https://www.mentors.org.tw/">陪伴者兒少生涯教育協會</a>
              </p>
            </div>

            <!-- <div class="col-md-4 col-sm-6 col-xs-12">
              <ul class="social-icons">
                <li><a class="facebook" href="#"><i class="fa fa-facebook"></i></a></li>
                <li><a class="twitter" href="#"><i class="fa fa-twitter"></i></a></li>
                <li><a class="dribbble" href="#"><i class="fa fa-dribbble"></i></a></li>
                <li><a class="linkedin" href="#"><i class="fa fa-linkedin"></i></a></li>   
              </ul>
            </div> -->
          </div>
        </div>
      </footer>
    </div>

    <!-- Display Firestore data -->
    <div id="firestore-data"></div>

    <script type="module">
      // Your web app's Firebase configuration
      import { auth, getCourses, addCourse, deleteCourse } from "./api.js";

      import {} from "./js/auth.js";
      import { createTable } from "./js/courseTable.js";
      import {} from "./js/dateDropdown.js";
      import {} from "./js/timeDropdownStart.js";
      import {} from "./js/timeDropdownEnd.js";

      const firestoreDataDiv = document.getElementById("firestore-data");

      // Code here
      getCourses().then((docs) => {
        const today = new Date();
        createTable(docs, today);
        // console.log(docs);
      });

      document
        .querySelector("#dropdownmenuclass")
        .addEventListener("click", function (event) {
          var selectedClass = event.target.textContent;
          var dropdownButton = document.getElementById("classDropdownButton");
          // 選取下拉選單元素
          var selection = document.getElementById("dropdownmenuclass");
          // 確認選中的選項索引，並將對應的值設置為下拉選單按鈕的文字內容
          dropdownButton.textContent = event.target.innerHTML;
        });

      document.getElementById("addCourseButton").onclick = () => {
        removeClass();
        const classinput1 = document.getElementById(
          "classDropdownButton"
        ).textContent;
        console.log(classinput1);
        const classinput2 = document.getElementById("classinput2");
        console.log(classinput2.value);
        const classinput3 = document.getElementById("classinput3");
        console.log(classinput3.value);

        const dateInput = document.getElementById("bookdate");
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0"); // 月份從0開始，需要加1
        const day = String(today.getDate()).padStart(2, "0");
        getDate();

        var dropdownButton1 = document.getElementById("timedropdown").innerHTML;
        var dropdownButton2 =
          document.getElementById("timedropdownEnd").innerHTML;

        var dropdownButtonvalue1 = parseInt(
          document.getElementById("timedropdown").value
        );
        var dropdownButtonvalue2 = parseInt(
          document.getElementById("timedropdownEnd").value
        );

        var timeDifference = dropdownButtonvalue2 - dropdownButtonvalue1;
        console.log(timeDifference);

        var valueToFind;
        var text;
        let timeValue = [];
        const startTime = 9; // 開始時間 9 點
        const endTime = 19; // 結束時間 7 點
        var i = 0;

        for (let hour = startTime; hour < endTime; hour++) {
          for (let minute = 0; minute < 60; minute += 30) {
            const time = `${hour.toString().padStart(2, "0")}:${minute
              .toString()
              .padStart(2, "0")}`;

            timeValue[i] = time;

            i++;
          }
        }
        var temp;

        let showTable = [];
        if (timeDifference > 0) {
          for (
            i = dropdownButtonvalue1;
            i <= dropdownButtonvalue1 + timeDifference - 1;
            i++
          ) {
            temp = timeValue[i] + " - " + timeValue[i + 1];
            showTable.push(temp);
          }
        }

        addCourse(
          new Date(dateInput.value),
          classinput1,
          classinput2.value,
          showTable,
          // timeValue[dropdownButtonvalue1] + " - " + timeValue[dropdownButtonvalue2],
          classinput3.value
        )
          .then(function () {
            console.log("Document successfully written!");
            var element = document.getElementById("loading");
            var element2 = document.getElementById("addsuccess");
            element.classList.add("visually-hidden");
            element2.classList.remove('visually-hidden');
            setTimeout(function() {
                element2.classList.add('visually-hidden');
            }, 2000);
            
          })
          .catch(function (error) {
            console.error("Error writing document: ", error);
            
          });
      };

      // deleteButton.onclick = deleteCourseInModal();

      document.getElementById("delete").onclick = () => {
        deleteButton.onclick = deleteCourseInModal();
      };

      function deleteCourseInModal() {
        getCourses().then((docs) => {
          console.log(docs);
          const courseListDiv = document.getElementById("course-list");
          courseListDiv.innerHTML = "";
          var dropdownButton1 =
            document.getElementById("timedropdown").innerHTML;
          var dropdownButton2 =
            document.getElementById("timedropdownEnd").innerHTML;

          docs.forEach((doc) => {
            const courseDiv = document.createElement("div");

            courseDiv.classList.add("course-item");

            const courseDate = new Date(doc.Date.seconds * 1000); // 假設日期是Firestore的Timestamp
            const formattedDate = courseDate.toLocaleDateString();

            //刪除
            courseDiv.textContent = `${formattedDate} | ${
              doc["Teacher"] || "N/A"
            } | ${doc["Course"] || "N/A"}  |  ${doc["Classroom"] || "N/A"} | `;
            courseDiv.insertAdjacentText(
              "beforeend",
              `${formattedDate} | ${
              doc["Sections"][0].substr(0,5) || "N/A"
            } - ${doc["Sections"][doc["Sections"].length - 1].substr(0,5)|| "N/A"} `
            );

            courseListDiv.appendChild(courseDiv);

            const deleteButton = document.createElement("button");

            // console.log(Id)

            deleteButton.textContent = "刪除";
            deleteButton.classList.add("delete-button");
            deleteButton.classList.add("btn");
            deleteButton.classList.add("btn-secondary");
            deleteButton.classList.add("btn-sm");

            deleteButton.addEventListener("click", () => {
              const docId = doc["Id"];
              deleteCourse(docId)
                .then(() => {
                  console.log("Document successfully deleted!");
                  deleteCourseInModal();
                })
                .catch((error) => {
                  console.error("Error deleting document: ", error);
                });
            });
            courseDiv.appendChild(deleteButton);
            courseListDiv.appendChild(courseDiv);
          });
        });
      }

      // 設置預設日期為今日日期
      function setDefaultDate() {
        const dateInput = document.getElementById("bookdate");
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0"); // 月份從0開始，需要加1
        const day = String(today.getDate()).padStart(2, "0");
        const formattedDate = `${year}-${month}-${day}`;
        dateInput.value = formattedDate;

        getDate();
      }

      function getDate() {
        const dateInput = document.getElementById("bookdate");
        const selectedDate = dateInput.value;
        console.log(`選擇的日期是: ${selectedDate}`);
      }

      // 當頁面加載時設置預設日期
      window.onload = setDefaultDate;

      document
        .querySelector("#timeDropdownStart")
        .addEventListener("click", function (event) {
          var selectedClass = event.target.textContent;
          var dropdownButton = document.getElementById("timedropdown");
          // 選取下拉選單元素
          var selection = document.getElementById("timeDropdownStart");
          // 確認選中的選項索引，並將對應的值設置為下拉選單按鈕的文字內容
          dropdownButton.textContent = event.target.innerHTML;
          dropdownButton.value = event.target.value;
        });

      document
        .querySelector("#timeDropdownEnd")
        .addEventListener("click", function (event) {
          var selectedClass = event.target.textContent;
          var dropdownButton = document.getElementById("timedropdownEnd");
          // 選取下拉選單元素
          var selection = document.getElementById("timeDropdownEnd");
          // 確認選中的選項索引，並將對應的值設置為下拉選單按鈕的文字內容
          dropdownButton.textContent = event.target.innerHTML;
          dropdownButton.value = event.target.value;
        });

      function removeClass() {
        var element = document.getElementById("loading");
        element.classList.remove("visually-hidden");
      }
    </script>
  </body>
</html>
